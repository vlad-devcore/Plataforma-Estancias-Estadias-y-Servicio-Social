name: Optimized Deploy to Production

on:
  push:
    branches:
      - main
    paths:
      - 'cliente/**'
      - 'Servidor/**'
      - '.github/workflows/**'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout con fetch-depth para tener historial
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Necesario para comparar con commit anterior

      # 2Ô∏è‚É£ Detectar cambios (CORREGIDO)
      - name: Detect changes
        run: |
          # Si es el primer push, comparar con HEAD
          if [ "${{ github.event.before }}" == "0000000000000000000000000000000000000000" ]; then
            echo "cliente_changed=true" >> $GITHUB_ENV
            echo "servidor_changed=true" >> $GITHUB_ENV
          else
            # Verificar si el commit anterior existe
            if git cat-file -e ${{ github.event.before }} 2>/dev/null; then
              CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
            else
              # Si no existe, usar HEAD~1
              CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
            fi
            
            echo "$CHANGED_FILES" | grep -q '^cliente/' && echo "cliente_changed=true" >> $GITHUB_ENV || echo "cliente_changed=false" >> $GITHUB_ENV
            echo "$CHANGED_FILES" | grep -q '^Servidor/' && echo "servidor_changed=true" >> $GITHUB_ENV || echo "servidor_changed=false" >> $GITHUB_ENV
          fi

      # 3Ô∏è‚É£ Mostrar qu√© cambi√≥ (para debugging)
      - name: Show detected changes
        run: |
          echo "Cliente changed: ${{ env.cliente_changed }}"
          echo "Servidor changed: ${{ env.servidor_changed }}"

      # 4Ô∏è‚É£ SSH Agent
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # 5Ô∏è‚É£ Known hosts
      - name: Add SSH known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H academico.upqroo.edu.mx >> ~/.ssh/known_hosts

      # 6Ô∏è‚É£ Deploy CLIENTE (Frontend)
      - name: Deploy cliente
        if: env.cliente_changed == 'true'
        run: |
          echo "üöÄ Deploying CLIENTE..."
          rsync -avz --progress \
            --exclude='node_modules' \
            --exclude='.env' \
            --exclude='build' \
            --exclude='.git' \
            --exclude='.next' \
            cliente/ \
            gestionvinculacion@academico.upqroo.edu.mx:/var/www/PEE/cliente

          ssh gestionvinculacion@academico.upqroo.edu.mx << 'EOF'
            set -e
            cd /var/www/PEE/cliente
            
            # Detener PM2 primero para liberar archivos
            echo "‚è∏Ô∏è  Stopping PM2 process..."
            pm2 stop front-PEE 2>/dev/null || echo "Process not running"
            
            # Limpiar cach√©s y node_modules problem√°ticos
            echo "üßπ Cleaning caches..."
            rm -rf node_modules/.cache
            rm -rf .cache
            rm -rf build
            
            # Instalar dependencias
            echo "üì¶ Installing dependencies..."
            npm install --prefer-offline --no-audit
            
            # Build
            echo "üî® Building..."
            npm run build
            
            # Reiniciar PM2
            echo "‚ôªÔ∏è  Restarting PM2..."
            if pm2 id frontend-PEE > /dev/null 2>&1; then
              pm2 restart frontend-PEE
            else
              pm2 start npm --name frontend-PEE -- start
            fi
            
            pm2 save
            echo "‚úÖ Cliente deployed successfully"
          EOF

      # 7Ô∏è‚É£ Deploy SERVIDOR (Backend)
      - name: Deploy Servidor
        if: env.servidor_changed == 'true'
        run: |
          echo "üöÄ Deploying SERVIDOR..."
          rsync -avz --progress \
            --exclude='node_modules' \
            --exclude='.env' \
            --exclude='.git' \
            Servidor/ \
            gestionvinculacion@academico.upqroo.edu.mx:/var/www/PEE/Servidor

          ssh gestionvinculacion@academico.upqroo.edu.mx << 'EOF'
            set -e
            cd /var/www/PEE/Servidor
            
            # Detener PM2 primero
            echo "‚è∏Ô∏è  Stopping PM2 process..."
            pm2 stop Back-PEE 2>/dev/null || echo "Process not running"
            
            # Limpiar cach√©s
            echo "üßπ Cleaning caches..."
            rm -rf node_modules/.cache
            
            # Instalar dependencias
            echo "üì¶ Installing dependencies..."
            npm install --prefer-offline --no-audit
            
            # Reiniciar PM2
            echo "‚ôªÔ∏è  Restarting PM2..."
            if pm2 id Back-PEE > /dev/null 2>&1; then
              pm2 restart Back-PEE
            else
              pm2 start index.js --name Back-PEE
            fi
            
            pm2 save
            echo "‚úÖ Servidor deployed successfully"
          EOF

      # 8Ô∏è‚É£ Resumen final
      - name: Deployment Summary
        if: always()
        run: |
          echo "üìä Deployment Summary:"
          echo "- Cliente deployed: ${{ env.cliente_changed }}"
          echo "- Servidor deployed: ${{ env.servidor_changed }}"