name: Optimized Deploy to Production

on:
  push:
    branches:
      - main
    paths:
      - 'cliente/**'
      - 'Servidor/**'
      - '.github/workflows/**'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      # 2Ô∏è‚É£ Detectar cambios
      - name: Detect changes
        run: |
          if [ "${{ github.event.before }}" == "0000000000000000000000000000000000000000" ]; then
            echo "cliente_changed=true" >> $GITHUB_ENV
            echo "servidor_changed=true" >> $GITHUB_ENV
          else
            if git cat-file -e ${{ github.event.before }} 2>/dev/null; then
              CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
            else
              CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
            fi

            echo "$CHANGED_FILES" | grep -q '^cliente/' && echo "cliente_changed=true" >> $GITHUB_ENV || echo "cliente_changed=false" >> $GITHUB_ENV
            echo "$CHANGED_FILES" | grep -q '^Servidor/' && echo "servidor_changed=true" >> $GITHUB_ENV || echo "servidor_changed=false" >> $GITHUB_ENV
          fi

      # 3Ô∏è‚É£ Debug
      - name: Show detected changes
        run: |
          echo "Cliente changed: ${{ env.cliente_changed }}"
          echo "Servidor changed: ${{ env.servidor_changed }}"

      # 4Ô∏è‚É£ SSH
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # 5Ô∏è‚É£ Known hosts
      - name: Add SSH known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H academico.upqroo.edu.mx >> ~/.ssh/known_hosts

      # 6Ô∏è‚É£ DEPLOY CLIENTE (FRONTEND - PRODUCCI√ìN REAL)
      - name: Deploy cliente
        if: env.cliente_changed == 'true'
        run: |
          echo "üöÄ Deploying CLIENTE..."
          rsync -az \
            --exclude='node_modules' \
            --exclude='.env' \
            --exclude='build' \
            --exclude='.git' \
            cliente/ \
            gestionvinculacion@academico.upqroo.edu.mx:/var/www/PEE/cliente

          ssh gestionvinculacion@academico.upqroo.edu.mx << 'EOF'
            set -e
            cd /var/www/PEE/cliente

            echo "üì¶ Installing dependencies..."
            npm install --prefer-offline --no-audit

            echo "üî® Building frontend..."
            npm run build

            echo "‚ôªÔ∏è Restarting PM2 frontend (PORT 3088)..."
            if pm2 id frontend-PEE > /dev/null 2>&1; then
              pm2 restart frontend-PEE
            else
              pm2 serve build 3088 --name frontend-PEE
            fi

            pm2 save
            echo "‚úÖ Frontend running on port 3088"
          EOF

      # 7Ô∏è‚É£ DEPLOY SERVIDOR (BACKEND)
      - name: Deploy Servidor
        if: env.servidor_changed == 'true'
        run: |
          echo "üöÄ Deploying SERVIDOR..."
          rsync -az \
            --exclude='node_modules' \
            --exclude='.env' \
            --exclude='.git' \
            Servidor/ \
            gestionvinculacion@academico.upqroo.edu.mx:/var/www/PEE/Servidor

          ssh gestionvinculacion@academico.upqroo.edu.mx << 'EOF'
            set -e
            cd /var/www/PEE/Servidor

            echo "üì¶ Installing dependencies..."
            npm install --prefer-offline --no-audit

            echo "‚ôªÔ∏è Restarting PM2 backend..."
            if pm2 id Back-PEE > /dev/null 2>&1; then
              pm2 restart Back-PEE
            else
              pm2 start index.js --name Back-PEE
            fi

            pm2 save
            echo "‚úÖ Backend running"
          EOF

      # 8Ô∏è‚É£ Resumen
      - name: Deployment Summary
        if: always()
        run: |
          echo "üìä Deployment Summary"
          echo "- Cliente deployed: ${{ env.cliente_changed }}"
          echo "- Servidor deployed: ${{ env.servidor_changed }}"
